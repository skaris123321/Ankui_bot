<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–∞–≤–∏–ª</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ñ</text></svg>">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/embed-editor.css">
  <style>
    .rules-editor-page {
      padding: 2rem 0;
    }
    
    .rule-item {
      background-color: var(--background-dark);
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      border-left: 3px solid var(--primary-color);
    }
    
    .rule-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .rule-item-header h4 {
      margin: 0;
      color: var(--text-primary);
    }
    
    .rule-item-fields {
      display: grid;
      gap: 1rem;
    }
    
    .rule-item-fields input,
    .rule-item-fields textarea {
      width: 100%;
      padding: 0.75rem;
      background: var(--background);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      color: var(--text-primary);
      font-family: inherit;
    }
    
    .rule-item-fields textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .remove-btn {
      background: #ED4245;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    
    .remove-btn:hover {
      background: #c0392b;
    }
    
    #rulesContainer {
      margin-top: 1rem;
    }
    
    .image-block-section {
      background-color: var(--background-dark);
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      border-left: 3px solid #57F287;
    }
  </style>
</head>
<body>
  <%- include('partials/header') %>
  
  <main class="rules-editor-page">
    <div class="container">
      <h1>üìú –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–∞–≤–∏–ª</h1>
      <p class="subtitle">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ —Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π –∏ —Å–ø–∏—Å–∫–æ–º –ø—Ä–∞–≤–∏–ª –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏</p>
      
      <div class="editor-layout">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - —Ä–µ–¥–∞–∫—Ç–æ—Ä -->
        <div class="editor-panel">
          <h2>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä</h2>
          
          <!-- –ë–ª–æ–∫ —Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π -->
          <div class="image-block-section">
            <h3 style="margin-top: 0; margin-bottom: 1rem;">üñºÔ∏è –ë–ª–æ–∫ —Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π (–ø–µ—Ä–≤—ã–π –±–ª–æ–∫)</h3>
            
            <div class="editor-section">
              <label>üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
              <input type="text" id="imageBlockTitle" class="input-field" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–û–ô–° –ö–ê–ù–ê–õ–´" maxlength="256">
            </div>
            
            <div class="editor-section">
              <label>üñºÔ∏è –ö–∞—Ä—Ç–∏–Ω–∫–∞ (URL) *</label>
              <input type="url" id="imageBlockImage" class="input-field" placeholder="https://example.com/image.png" oninput="updatePreview()">
              <small>–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ - —ç—Ç–æ –ø–µ—Ä–≤—ã–π –±–ª–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –≤–∏–¥–µ–Ω</small>
            </div>
          </div>
          
          <!-- –ü—Ä–∞–≤–∏–ª–∞ -->
          <div class="editor-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3 style="margin: 0;">üìã –ü—Ä–∞–≤–∏–ª–∞</h3>
              <button class="btn btn-primary" onclick="addRule()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ</button>
            </div>
            <div id="rulesContainer">
              <p style="color: var(--text-secondary); font-style: italic;">–ù–∞–∂–º–∏—Ç–µ "‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</p>
            </div>
          </div>
        </div>
        
        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
        <div class="preview-panel">
          <h2>üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h2>
          <div class="discord-preview">
            <div class="discord-message">
              <div class="message-avatar">
                <img src="https://cdn.discordapp.com/embed/avatars/0.png" alt="Bot">
              </div>
              <div class="message-content">
                <div class="message-header">
                  <span class="message-username">–í–∞—à –ë–æ—Ç</span>
                  <span class="message-badge">–ë–û–¢</span>
                  <span class="message-timestamp">–°–µ–≥–æ–¥–Ω—è –≤ <%= new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }) %></span>
                </div>
                <div id="embedPreview" class="embed-preview">
                  <!-- Embeds –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
                </div>
              </div>
            </div>
          </div>
          
          <div class="action-buttons">
            <h3>üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Discord</h3>
            <div class="send-options">
              <label>–ö–∞–Ω–∞–ª (ID)</label>
              <input type="text" id="targetChannel" class="input-field" placeholder="123456789012345678">
              <small>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID –∫–∞–Ω–∞–ª–∞ –∏–∑ Discord (–ü–ö–ú ‚Üí –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID)</small>
            </div>
            <button class="btn btn-primary btn-large" onclick="sendRules()">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Discord</button>
            <button class="btn btn-secondary btn-large" onclick="copyJSON()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON</button>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <%- include('partials/footer') %>
  
  <script>
    let rules = [];
    let ruleCounter = 0;
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞
    function addRule() {
      const ruleId = ruleCounter++;
      rules.push({
        id: ruleId,
        number: '',
        description: '',
        punishment: '',
        duration: ''
      });
      renderRules();
      updatePreview();
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞
    function removeRule(ruleId) {
      rules = rules.filter(r => r.id !== ruleId);
      renderRules();
      updatePreview();
    }
    
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—Ä–∞–≤–∏–ª
    function renderRules() {
      const container = document.getElementById('rulesContainer');
      
      if (rules.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary); font-style: italic;">–ù–∞–∂–º–∏—Ç–µ "‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</p>';
        return;
      }
      
      container.innerHTML = rules.map(rule => `
        <div class="rule-item" data-rule-id="${rule.id}">
          <div class="rule-item-header">
            <h4>–ü—Ä–∞–≤–∏–ª–æ ${rule.id + 1}</h4>
            <button class="remove-btn" onclick="removeRule(${rule.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
          </div>
          <div class="rule-item-fields">
            <div>
              <label>–ù–æ–º–µ—Ä –ø—Ä–∞–≤–∏–ª–∞:</label>
              <input type="text" 
                     placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2.1" 
                     value="${escapeHtml(rule.number)}"
                     oninput="updateRule(${rule.id}, 'number', this.value)">
            </div>
            <div>
              <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
              <textarea placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–∞–≤–∏–ª–æ..."
                        oninput="updateRule(${rule.id}, 'description', this.value)">${escapeHtml(rule.description)}</textarea>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div>
                <label>–ù–∞–∫–∞–∑–∞–Ω–∏–µ:</label>
                <input type="text" 
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–∞—Ä–Ω / –ú—É—Ç"
                       value="${escapeHtml(rule.punishment)}"
                       oninput="updateRule(${rule.id}, 'punishment', this.value)">
              </div>
              <div>
                <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</label>
                <input type="text" 
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–æ 30 –º–∏–Ω—É—Ç"
                       value="${escapeHtml(rule.duration)}"
                       oninput="updateRule(${rule.id}, 'duration', this.value)">
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞
    function updateRule(ruleId, field, value) {
      const rule = rules.find(r => r.id === ruleId);
      if (rule) {
        rule[field] = value;
        updatePreview();
      }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    function updatePreview() {
      const preview = document.getElementById('embedPreview');
      if (!preview) return;
      
      const imageBlockTitle = document.getElementById('imageBlockTitle')?.value || '';
      const imageBlockImage = document.getElementById('imageBlockImage')?.value || '';
      
      // –ï—Å–ª–∏ –Ω–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏ –Ω–µ—Ç –ø—Ä–∞–≤–∏–ª, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
      if (!imageBlockImage && rules.length === 0) {
        preview.innerHTML = '<div class="empty">–ù–∞—á–Ω–∏—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –±–ª–æ–∫ —Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π –∏ –ø—Ä–∞–≤–∏–ª–∞...</div>';
        preview.classList.add('empty');
        return;
      }
      
      preview.classList.remove('empty');
      
      let html = '';
      
      // –ü–µ—Ä–≤—ã–π –±–ª–æ–∫ - –∫–∞—Ä—Ç–∏–Ω–∫–∞
      if (imageBlockImage) {
        html += '<div class="embed" style="border-left: 4px solid #5865F2;">';
        if (imageBlockTitle) {
          html += `<div class="embed-title">${escapeHtml(imageBlockTitle)}</div>`;
        }
        html += `<div class="embed-image-container">`;
        html += `<img src="${imageBlockImage}" class="embed-image" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'color: #ED4245; padding: 1rem;\\'>‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>';" style="max-width: 100%; border-radius: 4px;">`;
        html += `</div>`;
        html += '</div>';
      }
      
      // –ë–ª–æ–∫–∏ —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏
      rules.forEach(rule => {
        if (!rule.description && !rule.number) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ –ø—Ä–∞–≤–∏–ª–∞
        
        html += '<div class="embed" style="border-left: 4px solid #5865F2; margin-top: 1rem;">';
        
        const ruleNumber = rule.number || '';
        const description = rule.description || '';
        
        let fieldValue = description ? `**${escapeHtml(description)}**` : '';
        
        if (rule.punishment || rule.duration) {
          fieldValue += '<br>';
          if (rule.punishment) {
            fieldValue += `<br>‚öñÔ∏è **–ù–∞–∫–∞–∑–∞–Ω–∏–µ:** ${escapeHtml(rule.punishment)}`;
          }
          if (rule.duration) {
            fieldValue += `<br>‚è±Ô∏è **–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** ${escapeHtml(rule.duration)}`;
          }
        }
        
        html += `<div class="embed-field">`;
        html += `<div class="embed-field-name">${ruleNumber ? `–ü—Ä–∞–≤–∏–ª–æ - ${escapeHtml(ruleNumber)}` : '–ü—Ä–∞–≤–∏–ª–æ'}</div>`;
        html += `<div class="embed-field-value">${fieldValue}</div>`;
        html += `</div>`;
        
        html += '</div>';
      });
      
      preview.innerHTML = html;
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∞–≤–∏–ª –≤ Discord
    async function sendRules() {
      const channelId = document.getElementById('targetChannel')?.value.trim();
      
      if (!channelId) {
        alert('‚ùå –í–≤–µ–¥–∏—Ç–µ ID –∫–∞–Ω–∞–ª–∞');
        return;
      }
      
      const imageBlockTitle = document.getElementById('imageBlockTitle')?.value || '';
      const imageBlockImage = document.getElementById('imageBlockImage')?.value || '';
      
      if (!imageBlockImage) {
        alert('‚ùå –î–æ–±–∞–≤—å—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ –ø–µ—Ä–≤—ã–π –±–ª–æ–∫');
        return;
      }
      
      if (rules.length === 0 || !rules.some(r => r.description)) {
        alert('‚ùå –î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø—Ä–∞–≤–∏–ª–æ');
        return;
      }
      
      // –°–æ–∑–¥–∞–µ–º embeds
      const embeds = [];
      
      // –ü–µ—Ä–≤—ã–π embed - –∫–∞—Ä—Ç–∏–Ω–∫–∞
      const imageEmbed = {
        color: 0x5865F2,
        image: {
          url: imageBlockImage
        }
      };
      
      if (imageBlockTitle) {
        imageEmbed.title = imageBlockTitle;
      }
      
      embeds.push(imageEmbed);
      
      // Embeds —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏
      rules.forEach(rule => {
        if (!rule.description) return;
        
        const ruleNumber = rule.number || '';
        const description = rule.description || '';
        
        let fieldValue = `**${description}**`;
        
        if (rule.punishment || rule.duration) {
          fieldValue += '\n';
          if (rule.punishment) {
            fieldValue += `\n‚öñÔ∏è **–ù–∞–∫–∞–∑–∞–Ω–∏–µ:** ${rule.punishment}`;
          }
          if (rule.duration) {
            fieldValue += `\n‚è±Ô∏è **–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** ${rule.duration}`;
          }
        }
        
        const ruleEmbed = {
          color: 0x5865F2,
          fields: [{
            name: ruleNumber ? `–ü—Ä–∞–≤–∏–ª–æ - ${ruleNumber}` : '–ü—Ä–∞–≤–∏–ª–æ',
            value: fieldValue,
            inline: false
          }]
        };
        
        embeds.push(ruleEmbed);
      });
      
      try {
        const response = await fetch('/api/send-rules', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            channelId: channelId,
            embeds: embeds
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('‚úÖ –ü—Ä–∞–≤–∏–ª–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Discord!');
        } else {
          alert('‚ùå –û—à–∏–±–∫–∞: ' + (result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∞–≤–∏–ª:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø—Ä–∞–≤–∏–ª: ' + error.message);
      }
    }
    
    // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ JSON
    function copyJSON() {
      const imageBlockTitle = document.getElementById('imageBlockTitle')?.value || '';
      const imageBlockImage = document.getElementById('imageBlockImage')?.value || '';
      
      const embeds = [];
      
      if (imageBlockImage) {
        const imageEmbed = {
          color: 0x5865F2,
          image: { url: imageBlockImage }
        };
        if (imageBlockTitle) {
          imageEmbed.title = imageBlockTitle;
        }
        embeds.push(imageEmbed);
      }
      
      rules.forEach(rule => {
        if (!rule.description) return;
        
        const ruleNumber = rule.number || '';
        const description = rule.description || '';
        let fieldValue = `**${description}**`;
        
        if (rule.punishment || rule.duration) {
          fieldValue += '\n';
          if (rule.punishment) fieldValue += `\n‚öñÔ∏è **–ù–∞–∫–∞–∑–∞–Ω–∏–µ:** ${rule.punishment}`;
          if (rule.duration) fieldValue += `\n‚è±Ô∏è **–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** ${rule.duration}`;
        }
        
        embeds.push({
          color: 0x5865F2,
          fields: [{
            name: ruleNumber ? `–ü—Ä–∞–≤–∏–ª–æ - ${ruleNumber}` : '–ü—Ä–∞–≤–∏–ª–æ',
            value: fieldValue,
            inline: false
          }]
        });
      });
      
      const json = JSON.stringify({ embeds: embeds }, null, 2);
      navigator.clipboard.writeText(json).then(() => {
        alert('‚úÖ JSON —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
      }).catch(err => {
        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
        alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON');
      });
    }
    
    // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏
    document.addEventListener('DOMContentLoaded', () => {
      const imageInput = document.getElementById('imageBlockImage');
      const titleInput = document.getElementById('imageBlockTitle');
      
      if (imageInput) {
        imageInput.addEventListener('input', updatePreview);
      }
      if (titleInput) {
        titleInput.addEventListener('input', updatePreview);
      }
      
      updatePreview();
    });
  </script>
</body>
</html>

