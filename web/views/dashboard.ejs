<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ñ</text></svg>">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/embed-editor.css">
  <style>
    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .server-selector {
      background: var(--background-light);
      padding: 1.5rem;
      border-radius: 10px;
      margin-bottom: 2rem;
    }
    
    .server-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .server-card {
      background: var(--background-dark);
      border: 2px solid transparent;
      border-radius: 10px;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }
    
    .server-card:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
    }
    
    .server-card.selected {
      border-color: var(--secondary-color);
      background: rgba(87, 242, 135, 0.1);
    }
    
    .server-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 0 auto 0.5rem;
      background: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: bold;
      color: white;
    }
    
    .server-icon img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .server-name {
      font-weight: bold;
      margin-bottom: 0.25rem;
      color: var(--text-primary);
    }
    
    .server-members {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    .channel-selector {
      background: var(--background-light);
      padding: 1.5rem;
      border-radius: 10px;
      margin-bottom: 2rem;
      display: none;
    }
    
    .channel-selector.visible {
      display: block;
    }
    
    .channel-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .channel-item {
      background: var(--background-dark);
      border: 2px solid transparent;
      border-radius: 5px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .channel-item:hover {
      border-color: var(--primary-color);
    }
    
    .channel-item.selected {
      border-color: var(--secondary-color);
      background: rgba(87, 242, 135, 0.1);
    }
    
    .embed-section {
      display: none;
    }
    
    .embed-section.visible {
      display: block;
    }
    
    /* –ü–∞–ª–∏—Ç—Ä–∞ —Ü–≤–µ—Ç–æ–≤ */
    .color-palette {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(35px, 1fr));
      gap: 8px;
      margin-top: 10px;
      padding: 10px;
      background: var(--background-dark);
      border-radius: 8px;
    }
    
    .color-swatch {
      width: 35px;
      height: 35px;
      border-radius: 6px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .color-swatch:hover {
      transform: scale(1.15);
      border-color: white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .color-swatch:active {
      transform: scale(0.95);
    }
    
    /* –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
    .image-upload-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .btn-upload {
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      display: inline-block;
      text-align: center;
      width: fit-content;
    }
    
    .file-name {
      font-size: 12px;
      color: var(--secondary-color);
      font-style: italic;
    }
    
    /* –ë–ª–æ–∫–∏ –ø—Ä–∞–≤–∏–ª */
    .rules-blocks-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .rule-block-item {
      background: var(--background-dark);
      border: 2px solid var(--background-light);
      border-radius: 8px;
      padding: 1rem;
      position: relative;
    }
    
    .rule-block-item:hover {
      border-color: var(--primary-color);
    }
    
    .rule-block-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--background-light);
    }
    
    .rule-block-title-input {
      background: var(--background-light);
      border: 1px solid var(--background-light);
      border-radius: 5px;
      padding: 0.5rem;
      color: var(--text-primary);
      font-size: 1rem;
      font-weight: bold;
      flex: 1;
      margin-right: 0.5rem;
    }
    
    .rule-block-title-input:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    
    .rule-block-remove-btn {
      background: var(--danger-color);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    
    .rule-block-remove-btn:hover {
      background: #c03537;
    }
    
    .rule-block-rules {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    
    .rule-item {
      background: var(--background-light);
      border-radius: 5px;
      padding: 0.75rem;
      border-left: 3px solid var(--primary-color);
    }
    
    .rule-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .rule-item-number {
      font-weight: bold;
      color: var(--primary-color);
      font-size: 0.9rem;
    }
    
    .rule-item-remove-btn {
      background: transparent;
      color: var(--danger-color);
      border: 1px solid var(--danger-color);
      padding: 0.25rem 0.5rem;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.75rem;
    }
    
    .rule-item-remove-btn:hover {
      background: var(--danger-color);
      color: white;
    }
    
    .rule-item-fields {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.5rem;
    }
    
    .rule-item-field-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
    }
    
    .rule-item-field {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    
    .rule-item-field label {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }
    
    .rule-item-field input,
    .rule-item-field textarea {
      background: var(--background-dark);
      border: 1px solid var(--background-light);
      border-radius: 3px;
      padding: 0.4rem;
      color: var(--text-primary);
      font-size: 0.85rem;
    }
    
    .rule-item-field input:focus,
    .rule-item-field textarea:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    
    .rule-item-field textarea {
      resize: vertical;
      min-height: 50px;
    }
    
    .rule-block-media {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--background-light);
    }
    
    .rule-block-media-field {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    
    .rule-block-media-field label {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    .rule-block-media-field input {
      background: var(--background-light);
      border: 1px solid var(--background-light);
      border-radius: 3px;
      padding: 0.4rem;
      color: var(--text-primary);
      font-size: 0.85rem;
    }
    
    .rule-block-media-field input:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    
    .add-rule-to-block-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      width: 100%;
    }
    
    .add-rule-to-block-btn:hover {
      background: #4752C4;
    }
  </style>
</head>
<body>
  <%- include('partials/header') %>
  
  <main class="dashboard-container">
    <h1>üé® –†–µ–¥–∞–∫—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –ø—Ä–∞–≤–∏–ª</h1>
    <p class="info-message" style="margin-bottom: 2rem;">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∫—Ä–∞—Å–∏–≤–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã–µ embed —Å–æ–æ–±—â–µ–Ω–∏—è —Å –±–ª–æ–∫–∞–º–∏ –ø—Ä–∞–≤–∏–ª –¥–ª—è –≤–∞—à–µ–≥–æ Discord —Å–µ—Ä–≤–µ—Ä–∞</p>
    
    <!-- –í—ã–±–æ—Ä —Å–µ—Ä–≤–µ—Ä–∞ -->
    <div class="server-selector">
      <h2>1Ô∏è‚É£ –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä</h2>
      <% if (guilds.length > 0) { %>
        <div class="server-grid">
          <% guilds.forEach(guild => { %>
            <div class="server-card" data-guild-id="<%= guild.id %>" onclick="selectGuild('<%= guild.id %>', '<%= guild.name %>')">
              <div class="server-icon">
                <% if (guild.icon) { %>
                  <img src="<%= guild.icon %>" alt="<%= guild.name %>">
                <% } else { %>
                  <%= guild.name.charAt(0).toUpperCase() %>
                <% } %>
              </div>
              <div class="server-name"><%= guild.name %></div>
              <div class="server-members">üë• <%= guild.memberCount %> —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
            </div>
          <% }); %>
        </div>
      <% } else { %>
        <div class="info-box">
          <p>‚ö†Ô∏è –ë–æ—Ç –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –Ω–∏ –∫ –æ–¥–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É.</p>
          <p>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø–æ —Å—Å—ã–ª–∫–µ:</p>
          <a href="https://discord.com/api/oauth2/authorize?client_id=1443654730239709206&permissions=8&scope=bot%20applications.commands" target="_blank" class="btn btn-primary">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –±–æ—Ç–∞</a>
        </div>
      <% } %>
    </div>
    
    <!-- –í—ã–±–æ—Ä –∫–∞–Ω–∞–ª–∞ -->
    <div class="channel-selector" id="channelSelector">
      <h2>2Ô∏è‚É£ –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª</h2>
      <p>–°–µ—Ä–≤–µ—Ä: <strong id="selectedGuildName">-</strong></p>
      <div class="channel-list" id="channelList">
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–Ω–∞–ª–æ–≤...</p>
      </div>
    </div>
    
    <!-- –†–µ–¥–∞–∫—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div class="embed-section" id="embedSection">
      <h2>3Ô∏è‚É£ –°–æ–∑–¥–∞–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</h2>
      
      <div class="editor-layout">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - —Ä–µ–¥–∞–∫—Ç–æ—Ä -->
        <div class="editor-panel">
          <h3>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä</h3>
          
          <div class="editor-section">
            <label>üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
            <input type="text" id="embedTitle" class="input-field" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫..." maxlength="256">
          </div>
          
          <div class="editor-section">
            <label>üìÑ –û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea id="embedDescription" class="textarea-field" rows="6" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç..." maxlength="4096"></textarea>
          </div>
          
          <!-- –ë–ª–æ–∫–∏ –ø—Ä–∞–≤–∏–ª -->
          <div class="editor-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <label style="margin: 0;">üìú –ë–ª–æ–∫–∏ –ø—Ä–∞–≤–∏–ª (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
              <button type="button" class="btn btn-secondary" onclick="toggleRulesBlocks()" id="toggleRulesBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫–∏ –ø—Ä–∞–≤–∏–ª</button>
            </div>
            <div id="rulesBlocksContainer" style="display: none; margin-top: 1rem;">
              <div id="rulesBlocksList" class="rules-blocks-list"></div>
              <button type="button" class="btn btn-success" onclick="addRulesBlock()" style="margin-top: 1rem; width: 100%;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫ –ø—Ä–∞–≤–∏–ª</button>
            </div>
          </div>
          
          <div class="editor-section">
            <label>üé® –¶–≤–µ—Ç</label>
            <div class="color-picker">
              <input type="color" id="embedColor" value="#5865F2">
              <span id="colorHex">#5865F2</span>
            </div>
            <div class="color-palette">
              <!-- Discord colors -->
              <button class="color-swatch" style="background: #5865F2" onclick="setColor('#5865F2')" title="Discord Blurple"></button>
              <button class="color-swatch" style="background: #57F287" onclick="setColor('#57F287')" title="–ó–µ–ª—ë–Ω—ã–π"></button>
              <button class="color-swatch" style="background: #ED4245" onclick="setColor('#ED4245')" title="–ö—Ä–∞—Å–Ω—ã–π"></button>
              <button class="color-swatch" style="background: #FEE75C" onclick="setColor('#FEE75C')" title="–ñ—ë–ª—Ç—ã–π"></button>
              <button class="color-swatch" style="background: #EB459E" onclick="setColor('#EB459E')" title="–†–æ–∑–æ–≤—ã–π"></button>
              
              <!-- –°–∏–Ω–∏–µ –æ—Ç—Ç–µ–Ω–∫–∏ -->
              <button class="color-swatch" style="background: #1E88E5" onclick="setColor('#1E88E5')" title="–°–∏–Ω–∏–π"></button>
              <button class="color-swatch" style="background: #42A5F5" onclick="setColor('#42A5F5')" title="–°–≤–µ—Ç–ª–æ-—Å–∏–Ω–∏–π"></button>
              <button class="color-swatch" style="background: #0D47A1" onclick="setColor('#0D47A1')" title="–¢—ë–º–Ω–æ-—Å–∏–Ω–∏–π"></button>
              <button class="color-swatch" style="background: #00BCD4" onclick="setColor('#00BCD4')" title="–ì–æ–ª—É–±–æ–π"></button>
              <button class="color-swatch" style="background: #80DEEA" onclick="setColor('#80DEEA')" title="–°–≤–µ—Ç–ª–æ-–≥–æ–ª—É–±–æ–π"></button>
              
              <!-- –ó–µ–ª—ë–Ω—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏ -->
              <button class="color-swatch" style="background: #4CAF50" onclick="setColor('#4CAF50')" title="–ó–µ–ª—ë–Ω—ã–π"></button>
              <button class="color-swatch" style="background: #8BC34A" onclick="setColor('#8BC34A')" title="–°–≤–µ—Ç–ª–æ-–∑–µ–ª—ë–Ω—ã–π"></button>
              <button class="color-swatch" style="background: #2E7D32" onclick="setColor('#2E7D32')" title="–¢—ë–º–Ω–æ-–∑–µ–ª—ë–Ω—ã–π"></button>
              <button class="color-swatch" style="background: #00E676" onclick="setColor('#00E676')" title="–ù–µ–æ–Ω –∑–µ–ª—ë–Ω—ã–π"></button>
              <button class="color-swatch" style="background: #69F0AE" onclick="setColor('#69F0AE')" title="–ú—è—Ç–Ω—ã–π"></button>
              
              <!-- –ñ—ë–ª—Ç—ã–µ/–û—Ä–∞–Ω–∂–µ–≤—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏ -->
              <button class="color-swatch" style="background: #FFEB3B" onclick="setColor('#FFEB3B')" title="–ñ—ë–ª—Ç—ã–π"></button>
              <button class="color-swatch" style="background: #FFC107" onclick="setColor('#FFC107')" title="–Ø–Ω—Ç–∞—Ä–Ω—ã–π"></button>
              <button class="color-swatch" style="background: #FF9800" onclick="setColor('#FF9800')" title="–û—Ä–∞–Ω–∂–µ–≤—ã–π"></button>
              <button class="color-swatch" style="background: #FF5722" onclick="setColor('#FF5722')" title="–¢—ë–º–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π"></button>
              <button class="color-swatch" style="background: #FFD54F" onclick="setColor('#FFD54F')" title="–ó–æ–ª–æ—Ç–æ–π"></button>
              
              <!-- –ö—Ä–∞—Å–Ω—ã–µ/–†–æ–∑–æ–≤—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏ -->
              <button class="color-swatch" style="background: #F44336" onclick="setColor('#F44336')" title="–ö—Ä–∞—Å–Ω—ã–π"></button>
              <button class="color-swatch" style="background: #E91E63" onclick="setColor('#E91E63')" title="–†–æ–∑–æ–≤—ã–π"></button>
              <button class="color-swatch" style="background: #C2185B" onclick="setColor('#C2185B')" title="–¢—ë–º–Ω–æ-—Ä–æ–∑–æ–≤—ã–π"></button>
              <button class="color-swatch" style="background: #FF1744" onclick="setColor('#FF1744')" title="–ù–µ–æ–Ω –∫—Ä–∞—Å–Ω—ã–π"></button>
              <button class="color-swatch" style="background: #F48FB1" onclick="setColor('#F48FB1')" title="–°–≤–µ—Ç–ª–æ-—Ä–æ–∑–æ–≤—ã–π"></button>
              
              <!-- –§–∏–æ–ª–µ—Ç–æ–≤—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏ -->
              <button class="color-swatch" style="background: #9C27B0" onclick="setColor('#9C27B0')" title="–§–∏–æ–ª–µ—Ç–æ–≤—ã–π"></button>
              <button class="color-swatch" style="background: #673AB7" onclick="setColor('#673AB7')" title="–¢—ë–º–Ω–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π"></button>
              <button class="color-swatch" style="background: #BA68C8" onclick="setColor('#BA68C8')" title="–°–≤–µ—Ç–ª–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π"></button>
              <button class="color-swatch" style="background: #E040FB" onclick="setColor('#E040FB')" title="–ù–µ–æ–Ω —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π"></button>
              <button class="color-swatch" style="background: #7C4DFF" onclick="setColor('#7C4DFF')" title="–ò–Ω–¥–∏–≥–æ"></button>
              
              <!-- –°–µ—Ä—ã–µ/–ß—ë—Ä–Ω—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏ -->
              <button class="color-swatch" style="background: #9E9E9E" onclick="setColor('#9E9E9E')" title="–°–µ—Ä—ã–π"></button>
              <button class="color-swatch" style="background: #607D8B" onclick="setColor('#607D8B')" title="–°–∏–Ω–µ-—Å–µ—Ä—ã–π"></button>
              <button class="color-swatch" style="background: #424242" onclick="setColor('#424242')" title="–¢—ë–º–Ω–æ-—Å–µ—Ä—ã–π"></button>
              <button class="color-swatch" style="background: #000000" onclick="setColor('#000000')" title="–ß—ë—Ä–Ω—ã–π"></button>
              <button class="color-swatch" style="background: #FFFFFF; border: 1px solid #ddd" onclick="setColor('#FFFFFF')" title="–ë–µ–ª—ã–π"></button>
            </div>
          </div>
          
          <div class="editor-section">
            <label>üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
            <div class="image-upload-group">
              <input type="url" id="embedImage" class="input-field" placeholder="https://example.com/image.png –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª (–¥–æ 2 –ú–ë)">
              <label for="embedImageFile" class="btn btn-secondary btn-upload">üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</label>
              <input type="file" id="embedImageFile" accept="image/*" style="display: none;">
              <span id="imageFileName" class="file-name"></span>
              <small style="color: var(--text-secondary); font-size: 12px;">üí° –î–ª—è —Ñ–∞–π–ª–æ–≤ –±–æ–ª—å—à–µ 2 –ú–ë –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ URL (–Ω–∞–ø—Ä–∏–º–µ—Ä, imgur.com). Discord –º–æ–∂–µ—Ç –Ω–µ –ø—Ä–∏–Ω—è—Ç—å data URL –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤.</small>
            </div>
          </div>
          
          <div class="editor-section">
            <label>üñºÔ∏è –ú–∏–Ω–∏–∞—Ç—é—Ä–∞</label>
            <div class="image-upload-group">
              <input type="url" id="embedThumbnail" class="input-field" placeholder="https://example.com/thumbnail.png –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª (–¥–æ 2 –ú–ë)">
              <label for="embedThumbnailFile" class="btn btn-secondary btn-upload">üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</label>
              <input type="file" id="embedThumbnailFile" accept="image/*" style="display: none;">
              <span id="thumbnailFileName" class="file-name"></span>
              <small style="color: var(--text-secondary); font-size: 12px;">üí° –î–ª—è —Ñ–∞–π–ª–æ–≤ –±–æ–ª—å—à–µ 2 –ú–ë –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ URL (–Ω–∞–ø—Ä–∏–º–µ—Ä, imgur.com). Discord –º–æ–∂–µ—Ç –Ω–µ –ø—Ä–∏–Ω—è—Ç—å data URL –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤.</small>
            </div>
          </div>
          
          <div class="editor-section">
            <label>üìã –§—É—Ç–µ—Ä</label>
            <input type="text" id="embedFooter" class="input-field" placeholder="–¢–µ–∫—Å—Ç –≤–Ω–∏–∑—É —Å–æ–æ–±—â–µ–Ω–∏—è" maxlength="2048">
          </div>
          
          <div class="editor-section">
            <label>‚è∞ –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞</label>
            <label class="checkbox-label">
              <input type="checkbox" id="embedTimestamp" checked>
              <span>–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è</span>
            </label>
          </div>
          
          <button class="btn btn-primary btn-large" onclick="sendEmbed()">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Discord</button>
        </div>
        
        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
        <div class="preview-panel">
          <h3>üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h3>
          <div class="discord-preview">
            <div class="discord-message">
              <div class="message-avatar">
                <img src="https://cdn.discordapp.com/embed/avatars/0.png" alt="Bot">
              </div>
              <div class="message-content">
                <div class="message-header">
                  <span class="message-username">–í–∞—à –ë–æ—Ç</span>
                  <span class="message-badge">–ë–û–¢</span>
                  <span class="message-timestamp">–°–µ–≥–æ–¥–Ω—è –≤ <%= new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }) %></span>
                </div>
                <div id="embedPreview" class="embed-preview empty">
                  –ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞...
                </div>
              </div>
            </div>
          </div>
          
          <div id="messageBox" class="message-box"></div>
        </div>
      </div>
    </div>
  </main>
  
  <%- include('partials/footer') %>
  
  <script src="/js/embed-editor.js"></script>
  <script>
    let selectedGuildId = null;
    let selectedChannelId = null;
    
    // –í—ã–±–æ—Ä —Å–µ—Ä–≤–µ—Ä–∞
    async function selectGuild(guildId, guildName) {
      selectedGuildId = guildId;
      selectedChannelId = null;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–æ–≤
      document.querySelectorAll('.server-card').forEach(card => {
        card.classList.remove('selected');
      });
      event.target.closest('.server-card').classList.add('selected');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –∫–∞–Ω–∞–ª–∞
      document.getElementById('selectedGuildName').textContent = guildName;
      document.getElementById('channelSelector').classList.add('visible');
      document.getElementById('embedSection').classList.remove('visible');
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–Ω–∞–ª—ã
      try {
        const response = await fetch(`/api/guild/${guildId}/channels`);
        const data = await response.json();
        
        if (data.success) {
          const channelList = document.getElementById('channelList');
          channelList.innerHTML = '';
          
          data.channels.forEach(channel => {
            const channelItem = document.createElement('div');
            channelItem.className = 'channel-item';
            channelItem.dataset.channelId = channel.id;
            channelItem.textContent = '# ' + channel.name;
            channelItem.onclick = () => selectChannel(channel.id, channel.name);
            channelList.appendChild(channelItem);
          });
        } else {
          document.getElementById('channelList').innerHTML = '<p>‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞–Ω–∞–ª—ã</p>';
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–Ω–∞–ª–æ–≤:', error);
        document.getElementById('channelList').innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–Ω–∞–ª–æ–≤</p>';
      }
    }
    
    // –í—ã–±–æ—Ä –∫–∞–Ω–∞–ª–∞
    function selectChannel(channelId, channelName) {
      selectedChannelId = channelId;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤
      document.querySelectorAll('.channel-item').forEach(item => {
        item.classList.remove('selected');
      });
      event.target.classList.add('selected');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
      document.getElementById('embedSection').classList.add('visible');
      
      // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ä–µ–¥–∞–∫—Ç–æ—Ä—É
      document.getElementById('embedSection').scrollIntoView({ behavior: 'smooth' });
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ embed - –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ embed-editor.js
    async function sendEmbed() {
      if (!selectedChannelId) {
        showMessage('error', '‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏!');
        return;
      }
      
      const embedData = getEmbedData();
      
      if (!embedData.title && !embedData.description) {
        showMessage('error', '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ!');
        return;
      }
      
      try {
        const response = await fetch('/api/send-embed', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            channelId: selectedChannelId,
            embed: embedData
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showMessage('success', '‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Discord!');
        } else {
          showMessage('error', `‚ùå –û—à–∏–±–∫–∞: ${result.message}`);
        }
      } catch (error) {
        console.error('Error:', error);
        showMessage('error', '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
      }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    document.getElementById('embedImageFile')?.addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
      if (!file.type.startsWith('image/')) {
        showMessage('error', '‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (JPG, PNG, GIF –∏ —Ç.–¥.)');
        e.target.value = '';
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ (–º–∞–∫—Å–∏–º—É–º 2 –ú–ë –¥–ª—è data URL)
      if (file.size > 2 * 1024 * 1024) {
        showMessage('error', '‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 2 –ú–ë). –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ URL –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–∞ imgur.com');
        e.target.value = '';
        return;
      }
      
      document.getElementById('imageFileName').textContent = `‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ ${file.name}...`;
      
      try {
        const url = await convertFileToDataURL(file);
        document.getElementById('embedImage').value = url;
        document.getElementById('imageFileName').textContent = `‚úÖ ${file.name} (${(file.size / 1024).toFixed(1)} –ö–ë)`;
        updatePreview();
        showMessage('success', '‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!');
      } catch (error) {
        console.error('Upload error:', error);
        showMessage('error', '‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + error.message);
        document.getElementById('imageFileName').textContent = '';
        e.target.value = '';
      }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∏–Ω–∏–∞—Ç—é—Ä—ã
    document.getElementById('embedThumbnailFile')?.addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      if (!file.type.startsWith('image/')) {
        showMessage('error', '‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (JPG, PNG, GIF –∏ —Ç.–¥.)');
        e.target.value = '';
        return;
      }
      
      if (file.size > 2 * 1024 * 1024) {
        showMessage('error', '‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 2 –ú–ë). –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ URL –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–∞ imgur.com');
        e.target.value = '';
        return;
      }
      
      document.getElementById('thumbnailFileName').textContent = `‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ ${file.name}...`;
      
      try {
        const url = await convertFileToDataURL(file);
        document.getElementById('embedThumbnail').value = url;
        document.getElementById('thumbnailFileName').textContent = `‚úÖ ${file.name} (${(file.size / 1024).toFixed(1)} –ö–ë)`;
        updatePreview();
        showMessage('success', '‚úÖ –ú–∏–Ω–∏–∞—Ç—é—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!');
      } catch (error) {
        console.error('Upload error:', error);
        showMessage('error', '‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + error.message);
        document.getElementById('thumbnailFileName').textContent = '';
        e.target.value = '';
      }
    });
    
    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–∞ –≤ base64 –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    async function convertFileToDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = async function(e) {
          const dataURL = e.target.result;
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä (–µ—Å–ª–∏ –±–æ–ª—å—à–µ 2 –ú–ë, –∏—Å–ø–æ–ª—å–∑—É–µ–º data URL –Ω–∞–ø—Ä—è–º—É—é)
          const base64Data = dataURL.split(',')[1];
          const sizeInBytes = (base64Data.length * 3) / 4;
          
          if (sizeInBytes > 2 * 1024 * 1024) {
            // –î–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º data URL –Ω–∞–ø—Ä—è–º—É—é
            // Discord –º–æ–∂–µ—Ç –Ω–µ –ø—Ä–∏–Ω—è—Ç—å, –Ω–æ –ø–æ–ø—Ä–æ–±—É–µ–º
            console.warn('File too large for server upload, using data URL directly');
            resolve(dataURL);
            return;
          }
          
          try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
            const response = await fetch('/api/upload-image', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ imageData: dataURL })
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
              throw new Error('Server returned non-JSON response');
            }
            
            const result = await response.json();
            
            if (result.success) {
              resolve(result.url);
            } else {
              reject(new Error(result.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'));
            }
          } catch (error) {
            // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –æ—à–∏–±–∫–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º data URL –Ω–∞–ø—Ä—è–º—É—é
            console.warn('Server upload failed, using data URL directly:', error.message);
            // Discord –º–æ–∂–µ—Ç –Ω–µ –ø—Ä–∏–Ω—è—Ç—å data URL, –Ω–æ –ø–æ–ø—Ä–æ–±—É–µ–º
            resolve(dataURL);
          }
        };
        
        reader.onerror = function() {
          reject(new Error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞'));
        };
        
        reader.readAsDataURL(file);
      });
    }
    
    // –ë–ª–æ–∫–∏ –ø—Ä–∞–≤–∏–ª
    let rulesBlocks = [];
    let rulesBlockCounter = 1;
    let rulesRuleCounter = 1;
    
    function toggleRulesBlocks() {
      const container = document.getElementById('rulesBlocksContainer');
      const btn = document.getElementById('toggleRulesBtn');
      
      if (container.style.display === 'none') {
        container.style.display = 'block';
        btn.textContent = '‚ûñ –°–∫—Ä—ã—Ç—å –±–ª–æ–∫–∏ –ø—Ä–∞–≤–∏–ª';
        renderRulesBlocks();
      } else {
        container.style.display = 'none';
        btn.textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫–∏ –ø—Ä–∞–≤–∏–ª';
      }
    }
    
    function addRulesBlock() {
      const block = {
        id: rulesBlockCounter++,
        title: '',
        rules: [],
        image: '',
        icon: ''
      };
      rulesBlocks.push(block);
      renderRulesBlocks();
      updateDescriptionWithRules();
    }
    
    function removeRulesBlock(blockId) {
      rulesBlocks = rulesBlocks.filter(b => b.id !== blockId);
      renderRulesBlocks();
      updateDescriptionWithRules();
    }
    
    function addRuleToBlock(blockId) {
      const block = rulesBlocks.find(b => b.id === blockId);
      if (block) {
        if (!block.rules) block.rules = [];
        const rule = {
          id: rulesRuleCounter++,
          number: '',
          description: '',
          punishment: '',
          duration: ''
        };
        block.rules.push(rule);
        renderRulesBlocks();
        updateDescriptionWithRules();
      }
    }
    
    function removeRuleFromBlock(blockId, ruleId) {
      const block = rulesBlocks.find(b => b.id === blockId);
      if (block && block.rules) {
        block.rules = block.rules.filter(r => r.id !== ruleId);
        renderRulesBlocks();
        updateDescriptionWithRules();
      }
    }
    
    function updateRuleField(blockId, ruleId, field, value) {
      const block = rulesBlocks.find(b => b.id === blockId);
      if (block && block.rules) {
        const rule = block.rules.find(r => r.id === ruleId);
        if (rule) {
          rule[field] = value;
          updateDescriptionWithRules();
        }
      }
    }
    
    function updateBlockField(blockId, field, value) {
      const block = rulesBlocks.find(b => b.id === blockId);
      if (block) {
        block[field] = value;
        updateDescriptionWithRules();
      }
    }
    
    function updateDescriptionWithRules() {
      const descriptionField = document.getElementById('embedDescription');
      if (!descriptionField) return;
      
      if (rulesBlocks.length === 0) {
        // –ï—Å–ª–∏ –Ω–µ—Ç –±–ª–æ–∫–æ–≤, –Ω–µ –º–µ–Ω—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
        return;
      }
      
      let descriptionText = descriptionField.value;
      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –±–ª–æ–∫–∏ –ø—Ä–∞–≤–∏–ª –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è (–µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
      // –ù–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ç–µ–∫—Å—Ç, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –≤–≤–µ–¥–µ–Ω –¥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–æ–≤
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∏–∑ –±–ª–æ–∫–æ–≤ –ø—Ä–∞–≤–∏–ª
      let rulesText = '';
      rulesBlocks.forEach(block => {
        if (block.title) {
          rulesText += `**${escapeMarkdown(block.title)}**\n\n`;
        }
        
        if (block.rules && block.rules.length > 0) {
          block.rules.forEach((rule, index) => {
            const ruleNumber = rule.number ? `**–ü—Ä–∞–≤–∏–ª–æ - ${rule.number}:**` : '';
            const ruleDescription = rule.description || '';
            const punishmentText = rule.punishment ? ` | –ù–∞–∫–∞–∑–∞–Ω–∏–µ: **${rule.punishment}**` : '';
            const durationText = rule.duration ? ` (–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${rule.duration})` : '';
            
            if (ruleDescription) {
              rulesText += `${ruleNumber} ${ruleDescription}${punishmentText}${durationText}`;
              if (index < block.rules.length - 1) {
                rulesText += '\n\n';
              }
            }
          });
        }
      });
      
      // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ç–µ–∫—Å—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –ø–µ—Ä–µ–¥ –±–ª–æ–∫–∞–º–∏ –ø—Ä–∞–≤–∏–ª
      const userText = descriptionField.dataset.userText || '';
      if (userText && !descriptionField.value.includes(rulesText)) {
        descriptionField.value = userText + (userText ? '\n\n' : '') + rulesText;
      } else {
        descriptionField.value = rulesText;
      }
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ç–µ–∫—Å—Ç
      if (!descriptionField.dataset.userText) {
        descriptionField.dataset.userText = descriptionField.value;
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º preview
      if (typeof updatePreview === 'function') {
        updatePreview();
      }
    }
    
    function renderRulesBlocks() {
      const container = document.getElementById('rulesBlocksList');
      if (!container) return;
      
      if (rulesBlocks.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 1rem;">–ë–ª–æ–∫–∏ –ø—Ä–∞–≤–∏–ª –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>';
        return;
      }
      
      container.innerHTML = rulesBlocks.map(block => `
        <div class="rule-block-item" data-block-id="${block.id}">
          <div class="rule-block-header">
            <input type="text" 
                   class="rule-block-title-input" 
                   value="${escapeHtml(block.title || '')}" 
                   placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–∞–≤–∏–ª–∞ —á–∞—Ç–∞)"
                   onchange="updateBlockField(${block.id}, 'title', this.value)">
            <button type="button" class="rule-block-remove-btn" onclick="removeRulesBlock(${block.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –±–ª–æ–∫</button>
          </div>
          
          <button type="button" class="add-rule-to-block-btn" onclick="addRuleToBlock(${block.id})">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ –≤ —ç—Ç–æ—Ç –±–ª–æ–∫</button>
          
          <div class="rule-block-rules">
            ${(block.rules && block.rules.length > 0) ? '' : `
              <p style="text-align: center; color: var(--text-secondary); font-style: italic; padding: 0.5rem;">–ü—Ä–∞–≤–∏–ª–∞ –≤ —ç—Ç–æ–º –±–ª–æ–∫–µ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>
            `}
            ${(block.rules || []).map(rule => `
              <div class="rule-item">
                <div class="rule-item-header">
                  <div class="rule-item-number">–ü—Ä–∞–≤–∏–ª–æ ${rule.number || rule.id}</div>
                  <button type="button" class="rule-item-remove-btn" onclick="removeRuleFromBlock(${block.id}, ${rule.id})">‚úï –£–¥–∞–ª–∏—Ç—å</button>
                </div>
                <div class="rule-item-fields">
                  <div class="rule-item-field">
                    <label>–ù–æ–º–µ—Ä –ø—Ä–∞–≤–∏–ª–∞:</label>
                    <input type="text" 
                           value="${escapeHtml(rule.number || '')}" 
                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2.1"
                           onchange="updateRuleField(${block.id}, ${rule.id}, 'number', this.value)">
                  </div>
                  <div class="rule-item-field">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                    <textarea placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–∞–≤–∏–ª–æ..."
                              onchange="updateRuleField(${block.id}, ${rule.id}, 'description', this.value)">${escapeHtml(rule.description || '')}</textarea>
                  </div>
                  <div class="rule-item-field-row">
                    <div class="rule-item-field">
                      <label>–ù–∞–∫–∞–∑–∞–Ω–∏–µ:</label>
                      <input type="text" 
                             value="${escapeHtml(rule.punishment || '')}" 
                             placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–µ–¥ / –º—É—Ç"
                             onchange="updateRuleField(${block.id}, ${rule.id}, 'punishment', this.value)">
                    </div>
                    <div class="rule-item-field">
                      <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</label>
                      <input type="text" 
                             value="${escapeHtml(rule.duration || '')}" 
                             placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–æ 30 –º–∏–Ω—É—Ç"
                             onchange="updateRuleField(${block.id}, ${rule.id}, 'duration', this.value)">
                    </div>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
          
          <div class="rule-block-media">
            <div class="rule-block-media-field">
              <label>üñºÔ∏è –ö–∞—Ä—Ç–∏–Ω–∫–∞ (URL):</label>
              <input type="url" 
                     value="${escapeHtml(block.image || '')}" 
                     placeholder="https://example.com/image.png"
                     onchange="updateBlockField(${block.id}, 'image', this.value)">
            </div>
            <div class="rule-block-media-field">
              <label>üé® –ò–∫–æ–Ω–∫–∞ (URL):</label>
              <input type="url" 
                     value="${escapeHtml(block.icon || '')}" 
                     placeholder="https://example.com/icon.png"
                     onchange="updateBlockField(${block.id}, 'icon', this.value)">
            </div>
          </div>
        </div>
      `).join('');
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function escapeMarkdown(text) {
      return text.replace(/\*/g, '\\*').replace(/_/g, '\\_').replace(/`/g, '\\`').replace(/\[/g, '\\[').replace(/\]/g, '\\]');
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ–ø–∏—Å–∞–Ω–∏—è –≤—Ä—É—á–Ω—É—é
    document.addEventListener('DOMContentLoaded', () => {
      const descriptionField = document.getElementById('embedDescription');
      if (descriptionField) {
        descriptionField.addEventListener('input', function() {
          if (rulesBlocks.length === 0) {
            this.dataset.userText = this.value;
          }
        });
      }
    });
  </script>
</body>
</html>
