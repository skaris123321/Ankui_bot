<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/embed-editor.css">
  <style>
    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .server-selector {
      background: var(--background-light);
      padding: 1.5rem;
      border-radius: 10px;
      margin-bottom: 2rem;
    }
    
    .server-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .server-card {
      background: var(--background-dark);
      border: 2px solid transparent;
      border-radius: 10px;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }
    
    .server-card:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
    }
    
    .server-card.selected {
      border-color: var(--secondary-color);
      background: rgba(87, 242, 135, 0.1);
    }
    
    .server-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 0 auto 0.5rem;
      background: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: bold;
      color: white;
    }
    
    .server-icon img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .server-name {
      font-weight: bold;
      margin-bottom: 0.25rem;
      color: var(--text-primary);
    }
    
    .server-members {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    .channel-selector {
      background: var(--background-light);
      padding: 1.5rem;
      border-radius: 10px;
      margin-bottom: 2rem;
      display: none;
    }
    
    .channel-selector.visible {
      display: block;
    }
    
    .channel-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .channel-item {
      background: var(--background-dark);
      border: 2px solid transparent;
      border-radius: 5px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .channel-item:hover {
      border-color: var(--primary-color);
    }
    
    .channel-item.selected {
      border-color: var(--secondary-color);
      background: rgba(87, 242, 135, 0.1);
    }
    
    .embed-section {
      display: none;
    }
    
    .embed-section.visible {
      display: block;
    }
  </style>
</head>
<body>
  <%- include('partials/header') %>
  
  <main class="dashboard-container">
    <h1>üé® –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è - –†–µ–¥–∞–∫—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π</h1>
    
    <!-- –í—ã–±–æ—Ä —Å–µ—Ä–≤–µ—Ä–∞ -->
    <div class="server-selector">
      <h2>1Ô∏è‚É£ –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä</h2>
      <% if (guilds.length > 0) { %>
        <div class="server-grid">
          <% guilds.forEach(guild => { %>
            <div class="server-card" data-guild-id="<%= guild.id %>" onclick="selectGuild('<%= guild.id %>', '<%= guild.name %>')">
              <div class="server-icon">
                <% if (guild.icon) { %>
                  <img src="<%= guild.icon %>" alt="<%= guild.name %>">
                <% } else { %>
                  <%= guild.name.charAt(0).toUpperCase() %>
                <% } %>
              </div>
              <div class="server-name"><%= guild.name %></div>
              <div class="server-members">üë• <%= guild.memberCount %> —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
            </div>
          <% }); %>
        </div>
      <% } else { %>
        <div class="info-box">
          <p>‚ö†Ô∏è –ë–æ—Ç –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –Ω–∏ –∫ –æ–¥–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É.</p>
          <p>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø–æ —Å—Å—ã–ª–∫–µ:</p>
          <a href="https://discord.com/api/oauth2/authorize?client_id=1443654730239709206&permissions=8&scope=bot%20applications.commands" target="_blank" class="btn btn-primary">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –±–æ—Ç–∞</a>
        </div>
      <% } %>
    </div>
    
    <!-- –í—ã–±–æ—Ä –∫–∞–Ω–∞–ª–∞ -->
    <div class="channel-selector" id="channelSelector">
      <h2>2Ô∏è‚É£ –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª</h2>
      <p>–°–µ—Ä–≤–µ—Ä: <strong id="selectedGuildName">-</strong></p>
      <div class="channel-list" id="channelList">
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–Ω–∞–ª–æ–≤...</p>
      </div>
    </div>
    
    <!-- –†–µ–¥–∞–∫—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div class="embed-section" id="embedSection">
      <h2>3Ô∏è‚É£ –°–æ–∑–¥–∞–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</h2>
      
      <div class="editor-layout">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - —Ä–µ–¥–∞–∫—Ç–æ—Ä -->
        <div class="editor-panel">
          <h3>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä</h3>
          
          <div class="editor-section">
            <label>üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
            <input type="text" id="embedTitle" class="input-field" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫..." maxlength="256">
          </div>
          
          <div class="editor-section">
            <label>üìÑ –û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea id="embedDescription" class="textarea-field" rows="6" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç..." maxlength="4096"></textarea>
          </div>
          
          <div class="editor-section">
            <label>üé® –¶–≤–µ—Ç</label>
            <div class="color-picker">
              <input type="color" id="embedColor" value="#5865F2">
              <span id="colorHex">#5865F2</span>
            </div>
            <div class="color-presets">
              <button class="color-btn" style="background: #5865F2" onclick="setColor('#5865F2')">Discord</button>
              <button class="color-btn" style="background: #57F287" onclick="setColor('#57F287')">–ó–µ–ª—ë–Ω—ã–π</button>
              <button class="color-btn" style="background: #ED4245" onclick="setColor('#ED4245')">–ö—Ä–∞—Å–Ω—ã–π</button>
              <button class="color-btn" style="background: #FEE75C" onclick="setColor('#FEE75C')">–ñ—ë–ª—Ç—ã–π</button>
              <button class="color-btn" style="background: #EB459E" onclick="setColor('#EB459E')">–†–æ–∑–æ–≤—ã–π</button>
              <button class="color-btn" style="background: #9B59B6" onclick="setColor('#9B59B6')">–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</button>
            </div>
          </div>
          
          <div class="editor-section">
            <label>üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (URL)</label>
            <input type="url" id="embedImage" class="input-field" placeholder="https://example.com/image.png">
          </div>
          
          <div class="editor-section">
            <label>üñºÔ∏è –ú–∏–Ω–∏–∞—Ç—é—Ä–∞ (URL)</label>
            <input type="url" id="embedThumbnail" class="input-field" placeholder="https://example.com/thumbnail.png">
          </div>
          
          <div class="editor-section">
            <label>üìã –§—É—Ç–µ—Ä</label>
            <input type="text" id="embedFooter" class="input-field" placeholder="–¢–µ–∫—Å—Ç –≤–Ω–∏–∑—É —Å–æ–æ–±—â–µ–Ω–∏—è" maxlength="2048">
          </div>
          
          <div class="editor-section">
            <label>‚è∞ –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞</label>
            <label class="checkbox-label">
              <input type="checkbox" id="embedTimestamp" checked>
              <span>–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è</span>
            </label>
          </div>
          
          <button class="btn btn-primary btn-large" onclick="sendEmbed()">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Discord</button>
        </div>
        
        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
        <div class="preview-panel">
          <h3>üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h3>
          <div class="discord-preview">
            <div class="discord-message">
              <div class="message-avatar">
                <img src="https://cdn.discordapp.com/embed/avatars/0.png" alt="Bot">
              </div>
              <div class="message-content">
                <div class="message-header">
                  <span class="message-username">–í–∞—à –ë–æ—Ç</span>
                  <span class="message-badge">–ë–û–¢</span>
                  <span class="message-timestamp">–°–µ–≥–æ–¥–Ω—è –≤ <%= new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }) %></span>
                </div>
                <div id="embedPreview" class="embed-preview empty">
                  –ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞...
                </div>
              </div>
            </div>
          </div>
          
          <div id="messageBox" class="message-box"></div>
        </div>
      </div>
    </div>
  </main>
  
  <%- include('partials/footer') %>
  
  <script src="/js/embed-editor.js"></script>
  <script>
    let selectedGuildId = null;
    let selectedChannelId = null;
    
    // –í—ã–±–æ—Ä —Å–µ—Ä–≤–µ—Ä–∞
    async function selectGuild(guildId, guildName) {
      selectedGuildId = guildId;
      selectedChannelId = null;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–æ–≤
      document.querySelectorAll('.server-card').forEach(card => {
        card.classList.remove('selected');
      });
      event.target.closest('.server-card').classList.add('selected');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –∫–∞–Ω–∞–ª–∞
      document.getElementById('selectedGuildName').textContent = guildName;
      document.getElementById('channelSelector').classList.add('visible');
      document.getElementById('embedSection').classList.remove('visible');
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–Ω–∞–ª—ã
      try {
        const response = await fetch(`/api/guild/${guildId}/channels`);
        const data = await response.json();
        
        if (data.success) {
          const channelList = document.getElementById('channelList');
          channelList.innerHTML = '';
          
          data.channels.forEach(channel => {
            const channelItem = document.createElement('div');
            channelItem.className = 'channel-item';
            channelItem.dataset.channelId = channel.id;
            channelItem.textContent = '# ' + channel.name;
            channelItem.onclick = () => selectChannel(channel.id, channel.name);
            channelList.appendChild(channelItem);
          });
        } else {
          document.getElementById('channelList').innerHTML = '<p>‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞–Ω–∞–ª—ã</p>';
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–Ω–∞–ª–æ–≤:', error);
        document.getElementById('channelList').innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–Ω–∞–ª–æ–≤</p>';
      }
    }
    
    // –í—ã–±–æ—Ä –∫–∞–Ω–∞–ª–∞
    function selectChannel(channelId, channelName) {
      selectedChannelId = channelId;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤
      document.querySelectorAll('.channel-item').forEach(item => {
        item.classList.remove('selected');
      });
      event.target.classList.add('selected');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
      document.getElementById('embedSection').classList.add('visible');
      
      // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ä–µ–¥–∞–∫—Ç–æ—Ä—É
      document.getElementById('embedSection').scrollIntoView({ behavior: 'smooth' });
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ embed - –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ embed-editor.js
    async function sendEmbed() {
      if (!selectedChannelId) {
        showMessage('error', '‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏!');
        return;
      }
      
      const embedData = getEmbedData();
      
      if (!embedData.title && !embedData.description) {
        showMessage('error', '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ!');
        return;
      }
      
      try {
        const response = await fetch('/api/send-embed', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            channelId: selectedChannelId,
            embed: embedData
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showMessage('success', '‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Discord!');
        } else {
          showMessage('error', `‚ùå –û—à–∏–±–∫–∞: ${result.message}`);
        }
      } catch (error) {
        console.error('Error:', error);
        showMessage('error', '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
      }
    }
  </script>
</body>
</html>
